<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Map | POMPAM</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
    * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: 'Prompt', 'Segoe UI', sans-serif;
  }
    #map { 
      height: 100vh; 
      width: 100vw; 
      z-index: 1; }
    
    body { 
      margin: 0; 
      padding: 0;
     }
    .top-bar {
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 60px;
      background:
    linear-gradient(to right, #d31c25, #c02129, #791115);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      font-size: 1.2rem;
      z-index: 1002;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .ai-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .ai-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }
    .bottom-panel {
      position: fixed;
      left: 50%;
      top: 75px;
      width: 90vw;
      max-width: 380px;
      min-width: 300px;
      transform: translateX(-50%);
      box-sizing: border-box;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      padding: 0;
      height: 70px;
      z-index: 1001;
      display: flex;
      flex-direction: row;
      align-items: center;
      border: 1px solid #e0e0e0;
    }

    .navigation-arrow {
      width: 70px;
      height: 70px;
      background:
    linear-gradient(to right, #d31c25, #791115);
      border-radius: 12px 0 0 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .navigation-arrow::before {
      content: "‚Üë";
      font-size: 32px;
      font-weight: bold;
      color: #ffffff;
      transform: rotate(0deg);
    }
    .navigation-info {
      flex: 1;
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 4px;
    }
    .destination-name {
      font-size: 16px;
      font-weight: 600;
      color: #202124;
      line-height: 1.2;
      margin: 0;
    }
    .destination-address {
      font-size: 14px;
      color: #5f6368;
      line-height: 1.3;
      margin: 0;
    }
    .navigation-distance {
      font-size: 12px;
      color: #1a73e8;
      font-weight: 500;
      margin: 0;
    }

    /* Responsive Design */
    @media (max-width: 480px) {
      .bottom-panel {
        width: 95vw;
        min-width: 280px;
        max-width: 350px;
        height: 65px;
      }
      
      .navigation-arrow {
        width: 60px;
        height: 65px;
      }
      
      .navigation-arrow::before {
        font-size: 28px;
      }
      
      .navigation-info {
        padding: 10px 14px;
        gap: 3px;
      }
      
      .destination-name {
        font-size: 14px;
      }
      
      .destination-address {
        font-size: 12px;
      }
      
      .navigation-distance {
        font-size: 11px;
      }
    }

    @media (max-width: 360px) {
      .bottom-panel {
        width: 98vw;
        min-width: 260px;
        max-width: 320px;
        height: 60px;
      }
      
      .navigation-arrow {
        width: 55px;
        height: 60px;
      }
      
      .navigation-arrow::before {
        font-size: 24px;
      }
      
      .navigation-info {
        padding: 8px 12px;
        gap: 2px;
      }
      
      .destination-name {
        font-size: 13px;
        line-height: 1.1;
      }
      
      .destination-address {
        font-size: 11px;
        line-height: 1.2;
      }
      
      .navigation-distance {
        font-size: 10px;
      }
    }

    @media (min-width: 768px) {
      .bottom-panel {
        max-width: 420px;
        height: 75px;
      }
      
      .navigation-arrow {
        width: 75px;
        height: 75px;
      }
      
      .navigation-arrow::before {
        font-size: 36px;
      }
      
      .navigation-info {
        padding: 14px 18px;
        gap: 5px;
      }
      
      .destination-name {
        font-size: 17px;
      }
      
      .destination-address {
        font-size: 15px;
      }
      
      .navigation-distance {
        font-size: 13px;
      }
    }


      .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 65px;
    background:
    linear-gradient(to right, #d31c25, #c02129, #791115);
    display: flex;
    justify-content: space-around;
    align-items: center;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
    box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.1);
    z-index: 999;
  }

  .bottom-nav .nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    color: white;
    font-size: 0.7rem;
    text-decoration: none !important;
  }

  .bottom-nav .nav-item img {
    width: 20px;
    height: 20px;
    margin-bottom: 2px;
  }

  /* AI Panel Styles */
  .ai-panel {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px 20px 0 0;
    box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.2);
    transform: translateY(100%);
    transition: transform 0.3s ease;
    z-index: 1000;
    max-height: 70vh;
    overflow-y: auto;
  }

  .ai-panel.active {
    transform: translateY(0);
  }

  .ai-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #eee;
  }

  .ai-title {
    font-size: 1.2rem;
    font-weight: bold;
    color: #e60000;
  }

  .close-ai-btn {
    background: #f8f9fa;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    cursor: pointer;
    display: flex;
    font-size: 5vh;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .close-ai-btn:hover {
    background: #e9ecef;
    transform: scale(1.1);
  }

  .route-suggestion {
    background: linear-gradient(135deg, #28a745, #20c997);
    border-left: 4px solid #155724;
    border-radius: 10px;
    padding: 15px;
    margin: 20px;
    color: white;
  }

  .route-title {
    font-weight: bold;
    margin-bottom: 10px;
  }

  .route-stats {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
  }

  .ai-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    padding: 0 20px 20px;
  }

  .ai-action-btn {
    background: linear-gradient(135deg, #e60000, #b8151e);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 15px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    flex: 1;
    min-width: 120px;
  }

  .ai-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(230, 0, 0, 0.3);
    background: linear-gradient(135deg, #ff1a1a, #cc0000);
  }

  @media (max-width: 768px) {
    .ai-actions {
      flex-direction: column;
    }
    
    .ai-action-btn {
      min-width: auto;
    }
  }

  </style>
</head>
<body>
  <div class="top-bar">
    <span>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏°‡πà‡∏Ñ‡πâ‡∏≤/‡∏û‡πà‡∏≠‡∏Ñ‡πâ‡∏≤</span>
    <button class="ai-btn" onclick="toggleAIRoute()">AI Route</button>
  </div>
  <div id="map"></div>
  <div class="bottom-panel">
    <div class="navigation-arrow"></div>
    <div class="navigation-info">
       <div class="destination-name">‡∏ñ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó</div>
       <div class="destination-address">‡∏°‡∏∏‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏π‡πà ‡∏ã‡∏≠‡∏¢‡∏≠‡πÇ‡∏®‡∏Å</div>
       <div class="navigation-distance">350 ‡∏°.</div>
     </div>
  </div>
    <nav class="bottom-nav">
      <a href="/merchant-main" class="nav-item">
        <img src="/static/images/Vector.png" alt="Home">
        <span>Home</span>
      </a>
      <a href="/merchant-map" class="nav-item">
        <img src="/static/images/Group.png" alt="Map">
        <span>Map</span>
      </a>
      <a href="/merchant-inventory" class="nav-item">
        <img src="/static/images/cart.png" alt="Inventory">
        <span>Inventory</span>
      </a>
      <a href="/merchant-preorder" class="nav-item">
        <img src="/static/images/pre-order.png" alt="Pre-order">
        <span>Pre-order</span>
      </a>
      <a href="/pos" class="nav-item">
        <img src="/static/images/pos.png" alt="Inventory">
        <span>POS</span>
      </a>
    
    </nav>

  <!-- AI Route Panel -->
  <div id="aiPanel" class="ai-panel">
    <div class="ai-header">
      <div class="ai-title">ü§ñ AI Route Optimizer</div>
      <button class="close-ai-btn" onclick="closeAIRoute()">√ó</button>
    </div>
    
    <div class="route-suggestion">
      <div class="route-title">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏£‡∏ñ A ‚Üí ‡∏£‡∏ñ B ‚Üí ‡∏£‡∏ñ C</div>
      <div class="route-stats">
        <span>‚è±Ô∏è 45 ‡∏ô‡∏≤‡∏ó‡∏µ</span>
        <span>üìç 12.5 ‡∏Å‡∏°.</span>
        <span>üí∞ ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î 25%</span>
      </div>
      <div>‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div>
    </div>
    
    <div class="ai-actions">
      <button class="ai-action-btn" onclick="optimizeRoute()">üéØ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</button>
      <button class="ai-action-btn" onclick="alternativeRoute()">üîÑ ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô</button>
      <button class="ai-action-btn" onclick="manageQueue()">üìã ‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß</button>
      <button class="ai-action-btn" onclick="weatherRoute()">üå§Ô∏è ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</button>
    </div>
  </div>
 
</body>
 <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    var centerLat = 13.7563;
    var centerLng = 100.5018;
    var map;
    var userMarker;
    // Define truck icon globally so it's available everywhere
    var truckIcon = L.icon({
      iconUrl: 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/icons/truck.svg',
      iconSize: [36, 36],
      iconAnchor: [18, 36],
      popupAnchor: [0, -36]
    });

    var personIcon = L.icon({
      iconUrl: 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/icons/truck.svg',
      iconSize: [36, 36],
      iconAnchor: [18, 36],
      popupAnchor: [0, -36]
    });

    // Makro store icon
    var makroIcon = L.icon({
      iconUrl: 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/icons/shop.svg',
      iconSize: [40, 40],
      iconAnchor: [20, 40],
      popupAnchor: [0, -40]
    });


    // Track which truck is selected for distance display
    var selectedTruck = 0;
    // Only one set of truck markers/routes/animations should be active at a time
    var truckMarkers = [];
    var truckRouteLines = [];
    var truckRoutes = [];
    var truckAnims = [];

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(pos) {
        centerLat = pos.coords.latitude;
        centerLng = pos.coords.longitude;
        map = L.map('map', { zoomControl: false }).setView([centerLat, centerLng], 20);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        userMarker = L.marker([centerLat, centerLng], {icon: personIcon}).addTo(map);
        
        // Add Makro store locations
        addMakroStores();
        // Set truck start/end points near current location
        // Increase the offset for a wider route range
        var offset = 0.03; // wider range
        var trucks = [
          { id: 1, name: 'Truck 1', color: '#e60000', start: [centerLat + offset, centerLng + offset], end: [centerLat - offset, centerLng - offset] },
          { id: 2, name: 'Truck 2', color: '#e60000', start: [centerLat - offset, centerLng + offset], end: [centerLat + offset, centerLng - offset] },
          { id: 3, name: 'Truck 3', color: '#e60000', start: [centerLat + offset, centerLng - offset], end: [centerLat - offset, centerLng + offset] }
        ];

        // Add 4 stops along Truck 1's route (as example, can be adapted for other trucks)
        var stopMarkers = [];
        var stopCoords = [];

        // Add event for truck select dropdown
        function setupTruckSelect() {
          var sel = document.getElementById('truck-select');
          if (sel) {
            sel.value = selectedTruck;
            sel.addEventListener('change', function(e) {
              selectedTruck = parseInt(this.value);
              updateDistance();
              updateTruckStopPanels();
            });
          }
        }
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
          setupTruckSelect();
        } else {
          document.addEventListener('DOMContentLoaded', setupTruckSelect);
        }
        function addTruckStopsMarkers() {
          // Clear previous stop markers
          if (stopMarkers && stopMarkers.length) {
            stopMarkers.forEach(m => map.removeLayer(m));
          }
          stopMarkers = [];
          stopCoords = [];
          // Add 4 evenly spaced stops along each truck's route
          trucks.forEach((truck, idx) => {
            var coords = truckRoutes[idx];
            if (!coords || coords.length < 2) return;
            var nStops = 4;
            for (let i = 0; i < nStops; i++) {
              var pos = Math.floor((coords.length-1) * (i/(nStops-1)));
              var coord = coords[pos];
              var truckStopData = {
                name: '‡∏à‡∏∏‡∏î‡∏à‡∏≠‡∏î‡∏£‡∏ñ #' + (idx+1) + '-' + (i+1),
                truckName: '‡∏£‡∏ñ‡∏õ‡πã‡∏≠‡∏°‡πÅ‡∏õ‡πã‡∏° #' + (idx+1),
                stopNumber: i+1,
                totalStops: nStops,
                estimatedTime: '10-15 ‡∏ô‡∏≤‡∏ó‡∏µ',
                services: ['‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î', '‡∏™‡πâ‡∏°‡∏ï‡∏≥', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°', '‡∏Ç‡∏ô‡∏°'],
                status: i === 0 ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏¢' : (i === 1 ? '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ' : '‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß')
              };
              
              var popupContent = `
                <div style="min-width: 280px;">
                  <h3 style="color: #d31c25; margin: 0 0 10px 0; font-size: 16px;">
                    üöö ${truckStopData.name}
                  </h3>
                  <p style="margin: 5px 0; font-size: 14px;">
                    <strong>üöõ ‡∏£‡∏ñ:</strong> ${truckStopData.truckName}
                  </p>
                  <p style="margin: 5px 0; font-size: 14px;">
                    <strong>üìç ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà:</strong> ${truckStopData.stopNumber}/${truckStopData.totalStops}
                  </p>
                  <p style="margin: 5px 0; font-size: 14px;">
                    <strong>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏î:</strong> ${truckStopData.estimatedTime}
                  </p>
                  <p style="margin: 5px 0; font-size: 14px;">
                    <strong>üçΩÔ∏è ‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong><br>
                    ${truckStopData.services.join(', ')}
                  </p>
                  <p style="margin: 5px 0; font-size: 14px;">
                    <strong>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> 
                    <span style="color: ${truckStopData.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏¢' ? '#28a745' : (truckStopData.status === '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ' ? '#ffc107' : '#6c757d')}; font-weight: bold;">
                      ${truckStopData.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏¢' ? 'üü¢' : (truckStopData.status === '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ' ? 'üü°' : '‚ö™')} ${truckStopData.status}
                    </span>
                  </p>
                  <div style="margin-top: 15px; display: flex; gap: 5px;">
                    <button onclick="preOrderAtStop(${coord[0]}, ${coord[1]}, '${truckStopData.name}')" 
                            style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; flex: 1;">
                      üì± ‡∏™‡∏±‡πà‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤
                    </button>
                    <button onclick="setReminder(${coord[0]}, ${coord[1]}, '${truckStopData.name}')" 
                            style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; flex: 1;">
                      üîî ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                    </button>
                  </div>
                  <div style="margin-top: 5px;">
                    <button onclick="navigateToStop(${coord[0]}, ${coord[1]})" 
                            style="background: #d31c25; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 14px; width: 100%;">
                      üß≠ ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏à‡∏∏‡∏î‡∏à‡∏≠‡∏î
                    </button>
                  </div>
                </div>
              `;
              
              var marker = L.marker(coord, {icon: L.icon({
                iconUrl: 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/icons/geo-alt-fill.svg',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
              })}).addTo(map).bindPopup(popupContent, {maxWidth: 320});
              stopMarkers.push(marker);
              // Store extra info: {coord, truckIdx, stopIdx}
              stopCoords.push({coord: coord, truckIdx: idx, stopIdx: i});
            }
          });
        }
        // Clear any previous trucks/routes/animations
        truckMarkers.forEach(m => { if (m) map.removeLayer(m); });
        truckRouteLines.forEach(l => { if (l) map.removeLayer(l); });
        truckMarkers = [];
        truckRouteLines = [];
        truckRoutes = [];
        truckAnims = [];
        function fetchAndAnimateTruck(idx) {
          var truck = trucks[idx];
          var url = `https://router.project-osrm.org/route/v1/driving/${truck.start[1]},${truck.start[0]};${truck.end[1]},${truck.end[0]}?overview=full&geometries=geojson`;
          fetch(url)
            .then(res => res.json())
            .then(data => {
              if (data.routes && data.routes[0]) {
                var coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                truckRoutes[idx] = coords;
                if (truckRouteLines[idx]) map.removeLayer(truckRouteLines[idx]);
                truckRouteLines[idx] = L.polyline(coords, {color: truck.color, weight: 5, opacity: 0.7}).addTo(map);
                if (truckMarkers[idx]) map.removeLayer(truckMarkers[idx]);
                truckMarkers[idx] = L.marker(coords[0], {icon: truckIcon}).addTo(map).bindTooltip(truck.name, {permanent: false, direction: 'top'});
                // Store current truck position for distance calculation
                trucks[idx].lat = coords[0][0];
                trucks[idx].lng = coords[0][1];
                // Add click to select truck for distance display
                truckMarkers[idx].on('click', function() {
                  selectedTruck = idx;
                  updateDistance();
                  updateTruckStopPanels();
                });
                animateTruckLoop(idx, coords);
                // ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î route ‡∏Ç‡∏≠‡∏á truck ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á marker ‡∏à‡∏∏‡∏î‡∏à‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                if(idx === trucks.length-1) {
                  addTruckStopsMarkers();
                  updateTruckStopPanels();
                  // Ensure dropdown is in sync after all routes loaded
                  setupTruckSelect();
                }
              }
            });
        }
        // Utility: Find nearest stop to a given lat/lng
        function findNearestStop(lat, lng) {
          if (!stopCoords.length) return {idx: -1, dist: Infinity};
          var minIdx = 0, minDist = calcDistance(lat, lng, stopCoords[0].coord[0], stopCoords[0].coord[1]);
          for (let i = 1; i < stopCoords.length; i++) {
            var d = calcDistance(lat, lng, stopCoords[i].coord[0], stopCoords[i].coord[1]);
            if (d < minDist) { minDist = d; minIdx = i; }
          }
          return {idx: minIdx, dist: minDist};
        }

        // Update bottom-panel info
        function updateTruckStopPanels() {
          // Next stop for selected truck
          if (
            typeof selectedTruck === 'number' &&
            truckRoutes[selectedTruck] &&
            truckRoutes[selectedTruck].length > 1
          ) {
            var t = trucks[selectedTruck];
            // ‡∏´‡∏≤ stop ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ truck ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î‡∏à‡∏≠‡∏î‡∏ö‡∏ô route ‡∏Ç‡∏≠‡∏á truck ‡∏ô‡∏±‡πâ‡∏ô)
            var truckStops = [];
            var coords = truckRoutes[selectedTruck];
            var nStops = 4;
            for (let i = 0; i < nStops; i++) {
              var pos = Math.floor((coords.length-1) * (i/(nStops-1)));
              truckStops.push(coords[pos]);
            }
            // ‡∏´‡∏≤ index ‡∏à‡∏∏‡∏î‡∏à‡∏≠‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ truck ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
            var minIdx = 0, minDist = calcDistance(t.lat, t.lng, truckStops[0][0], truckStops[0][1]);
            for (let i = 1; i < truckStops.length; i++) {
              var d = calcDistance(t.lat, t.lng, truckStops[i][0], truckStops[i][1]);
              if (d < minDist) { minDist = d; minIdx = i; }
            }
            document.getElementById('next-truck-stop').textContent = '‡∏à‡∏∏‡∏î #' + (minIdx+1) + ' (Truck #' + (selectedTruck+1) + ')';
          } else {
            document.getElementById('next-truck-stop').textContent = '-';
          }
          // Nearest stop to user (‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å stop)
          if (stopCoords.length) {
            var nearest = findNearestStop(centerLat, centerLng);
            var stop = stopCoords[nearest.idx];
            document.getElementById('nearest-stop').textContent =
              '‡∏à‡∏∏‡∏î #' + (stop.stopIdx+1) + ' (Truck #' + (stop.truckIdx+1) + ')' +
              ' (' + stop.coord[0].toFixed(5) + ', ' + stop.coord[1].toFixed(5) + ')';
          } else {
            document.getElementById('nearest-stop').textContent = '-';
          }
        }
        function animateTruckLoop(idx, coords) {
          var i = 0;
          var forward = true;
          // Calculate stop positions for this truck
          var nStops = 4;
          var stopPositions = [];
          for (let s = 0; s < nStops; s++) {
            var pos = Math.floor((coords.length-1) * (s/(nStops-1)));
            stopPositions.push(pos);
          }
          function move() {
            if (!truckMarkers[idx]) return;
            trucks[idx].lat = coords[i][0];
            trucks[idx].lng = coords[i][1];
            truckMarkers[idx].setLatLng([trucks[idx].lat, trucks[idx].lng]);
            if (selectedTruck === idx) updateDistance();
            // Check if at a stop position
            if (stopPositions.includes(i)) {
              // Pause for 10 seconds at stop
              truckAnims[idx] = setTimeout(function() {
                nextStep();
              }, 10000); // 10,000 ms = 10 sec
            } else {
              truckAnims[idx] = setTimeout(function() {
                nextStep();
              }, 900); // normal step
            }
          }
          function nextStep() {
            if (forward) {
              i++;
              if (i >= coords.length - 1) {
                forward = false;
              }
            } else {
              i--;
              if (i <= 0) {
                forward = true;
              }
            }
            move();
          }
          move();
        }
        for (let idx = 0; idx < trucks.length; idx++) {
          fetchAndAnimateTruck(idx);
        }
        updateDistance();
        updateTruckStopPanels();
        navigator.geolocation.watchPosition(function(pos) {
          centerLat = pos.coords.latitude;
          centerLng = pos.coords.longitude;
          userMarker.setLatLng([centerLat, centerLng]);
          map.setView([centerLat, centerLng], 20);
          updateDistance();
          updateTruckStopPanels();
        });
      }, function() {
        fallbackMapSetup();
      });
    } else {
      fallbackMapSetup();
    }

    function fallbackMapSetup() {
      map = L.map('map', { zoomControl: false }).setView([centerLat, centerLng], 20);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);
      userMarker = L.marker([centerLat, centerLng], {icon: personIcon}).addTo(map);
      // Add Makro stores in fallback setup too
      addMakroStores();
    }


    function calcDistance(lat1, lng1, lat2, lng2) {
      function toRad(x) { return x * Math.PI / 180; }
      var R = 6371;
      var dLat = toRad(lat2 - lat1);
      var dLng = toRad(lng2 - lng1);
      var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Function to add Makro store markers
    function addMakroStores() {
      var makroStores = [
        {
          name: 'MAKRO ‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß',
          lat: 13.8167,
          lng: 100.5692,
          address: '1234 ‡∏ñ‡∏ô‡∏ô‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß ‡πÅ‡∏Ç‡∏ß‡∏á‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£ ‡πÄ‡∏Ç‡∏ï‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£ ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø 10900',
          phone: '02-123-4567',
          hours: '‡πÄ‡∏õ‡∏¥‡∏î 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á'
        },
        {
          name: 'MAKRO ‡∏£‡∏≤‡∏°‡∏Ñ‡∏≥‡πÅ‡∏´‡∏á',
          lat: 13.7633,
          lng: 100.6089,
          address: '2468 ‡∏ñ‡∏ô‡∏ô‡∏£‡∏≤‡∏°‡∏Ñ‡∏≥‡πÅ‡∏´‡∏á ‡πÅ‡∏Ç‡∏ß‡∏á‡∏´‡∏±‡∏ß‡∏´‡∏°‡∏≤‡∏Å ‡πÄ‡∏Ç‡∏ï‡∏ö‡∏≤‡∏á‡∏Å‡∏∞‡∏õ‡∏¥ ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø 10240',
          phone: '02-234-5678',
          hours: '‡πÄ‡∏õ‡∏¥‡∏î 06:00-22:00'
        },
        {
          name: 'MAKRO ‡∏ö‡∏≤‡∏á‡∏ô‡∏≤',
          lat: 13.6678,
          lng: 100.6089,
          address: '3579 ‡∏ñ‡∏ô‡∏ô‡∏ö‡∏≤‡∏á‡∏ô‡∏≤-‡∏ï‡∏£‡∏≤‡∏î ‡πÅ‡∏Ç‡∏ß‡∏á‡∏ö‡∏≤‡∏á‡∏ô‡∏≤ ‡πÄ‡∏Ç‡∏ï‡∏ö‡∏≤‡∏á‡∏ô‡∏≤ ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø 10260',
          phone: '02-345-6789',
          hours: '‡πÄ‡∏õ‡∏¥‡∏î 06:00-22:00'
        },
        {
          name: 'MAKRO ‡∏™‡∏≤‡∏ó‡∏£',
          lat: 13.7200,
          lng: 100.5300,
          address: '4680 ‡∏ñ‡∏ô‡∏ô‡∏™‡∏≤‡∏ó‡∏£ ‡πÅ‡∏Ç‡∏ß‡∏á‡∏™‡∏µ‡∏•‡∏° ‡πÄ‡∏Ç‡∏ï‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø 10500',
          phone: '02-456-7890',
          hours: '‡πÄ‡∏õ‡∏¥‡∏î 06:00-22:00'
        },
        {
          name: 'MAKRO ‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏° 4',
          lat: 13.7300,
          lng: 100.5500,
          address: '5791 ‡∏ñ‡∏ô‡∏ô‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏° 4 ‡πÅ‡∏Ç‡∏ß‡∏á‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢ ‡πÄ‡∏Ç‡∏ï‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢ ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø 10110',
          phone: '02-567-8901',
          hours: '‡πÄ‡∏õ‡∏¥‡∏î 06:00-22:00'
        },
        {
          name: 'MAKRO ‡∏£‡∏±‡∏ä‡∏î‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å',
          lat: 13.7800,
          lng: 100.5400,
          address: '6802 ‡∏ñ‡∏ô‡∏ô‡∏£‡∏±‡∏ä‡∏î‡∏≤‡∏†‡∏¥‡πÄ‡∏©‡∏Å ‡πÅ‡∏Ç‡∏ß‡∏á‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á ‡πÄ‡∏Ç‡∏ï‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø 10400',
          phone: '02-678-9012',
          hours: '‡πÄ‡∏õ‡∏¥‡∏î 06:00-22:00'
        }
      ];

      makroStores.forEach(function(store) {
        var popupContent = `
          <div style="min-width: 250px;">
            <h3 style="color: #d31c25; margin: 0 0 10px 0; font-size: 16px;">
              üè™ ${store.name}
            </h3>
            <p style="margin: 5px 0; font-size: 14px;">
              <strong>üìç ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong><br>
              ${store.address}
            </p>
            <p style="margin: 5px 0; font-size: 14px;">
              <strong>üìû ‡πÇ‡∏ó‡∏£:</strong> ${store.phone}
            </p>
            <p style="margin: 5px 0; font-size: 14px;">
              <strong>üïê ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î:</strong> ${store.hours}
            </p>
            <div style="margin-top: 10px; text-align: center;">
              <button onclick="navigateToMakro(${store.lat}, ${store.lng})" 
                      style="background: #d31c25; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 14px;">
                üß≠ ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ MAKRO
              </button>
            </div>
          </div>
        `;
        
        L.marker([store.lat, store.lng], {icon: makroIcon})
          .addTo(map)
          .bindPopup(popupContent, {maxWidth: 300});
      });
    }


    // function updateDistance() {
    //   // Only update if selectedTruck is valid and truck has a position
    //   if (typeof selectedTruck !== 'number' || !trucks[selectedTruck] || typeof trucks[selectedTruck].lat !== 'number' || typeof trucks[selectedTruck].lng !== 'number') {
    //     document.getElementById('truck-distance').textContent = '-';
    //     return;
    //   }
    //   var t = trucks[selectedTruck];
    //   var dist = calcDistance(centerLat, centerLng, t.lat, t.lng);
    //   var distText = dist < 1 ? (dist*1000).toFixed(0) + ' m' : dist.toFixed(2) + ' km';
    //   document.getElementById('truck-distance').textContent = distText;
    // }

    // var truckRow = document.createElement('div');
    // truckRow.className = 'panel-row';
    // truckRow.innerHTML = '<span class="panel-label">‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏ñ‡∏õ‡πã‡∏≠‡∏°‡πÅ‡∏õ‡πã‡∏°</span> <span class="panel-value" id="truck-distance"></span>';
    // document.querySelector('.bottom-panel').insertBefore(truckRow, document.querySelector('.bottom-panel').children[1]);
    // updateDistance();


    // ...removed legacy moveTruckOnRoute logic...
    if (map) {
      var latOffset = 0.5;
      var lngOffset = 0.5 / (111 * Math.cos(centerLat * Math.PI / 180));
      var southWest = [centerLat - latOffset, centerLng - lngOffset];
      var northEast = [centerLat + latOffset, centerLng + lngOffset];
      var bounds = L.latLngBounds(southWest, northEast);
      map.setMaxBounds(bounds);
    }

    // Navigation to Makro function
    function navigateToMakro(lat, lng) {
      Swal.fire({
        title: 'üß≠ ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ MAKRO',
        html: `
          <div style="text-align: left; margin: 20px 0;">
            <p><strong>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏≠‡∏õ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á:</strong></p>
            <div style="margin: 15px 0;">
              <button onclick="openGoogleMaps(${lat}, ${lng})" 
                      style="background: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin: 5px; cursor: pointer; width: 100%;">
                üì± Google Maps
              </button>
              <button onclick="openAppleMaps(${lat}, ${lng})" 
                      style="background: #007aff; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin: 5px; cursor: pointer; width: 100%;">
                üçé Apple Maps
              </button>
              <button onclick="showDirections(${lat}, ${lng})" 
                      style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin: 5px; cursor: pointer; width: 100%;">
                üó∫Ô∏è ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
              </button>
            </div>
          </div>
        `,
        showCloseButton: true,
        showConfirmButton: false
      });
    }

    function openGoogleMaps(lat, lng) {
      var url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
      window.open(url, '_blank');
      Swal.close();
    }

    function openAppleMaps(lat, lng) {
      var url = `http://maps.apple.com/?daddr=${lat},${lng}`;
      window.open(url, '_blank');
      Swal.close();
    }

    function showDirections(lat, lng) {
      // Center map on the selected Makro store
      map.setView([lat, lng], 15);
      
      // Show route from current location to Makro
      if (userMarker) {
        var userPos = userMarker.getLatLng();
        var routeUrl = `https://router.project-osrm.org/route/v1/driving/${userPos.lng},${userPos.lat};${lng},${lat}?overview=full&geometries=geojson`;
        
        fetch(routeUrl)
          .then(res => res.json())
          .then(data => {
            if (data.routes && data.routes[0]) {
              var coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
              var routeLine = L.polyline(coords, {color: '#d31c25', weight: 4, opacity: 0.8}).addTo(map);
              
              // Show distance and duration
              var distance = (data.routes[0].distance / 1000).toFixed(1);
              var duration = Math.round(data.routes[0].duration / 60);
              
              Swal.fire({
                title: 'üó∫Ô∏è ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ MAKRO',
                html: `
                  <div style="text-align: center; margin: 20px 0;">
                    <p><strong>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á:</strong> ${distance} ‡∏Å‡∏°.</p>
                    <p><strong>‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì:</strong> ${duration} ‡∏ô‡∏≤‡∏ó‡∏µ</p>
                    <p style="color: #28a745; margin-top: 15px;">‚úÖ ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</p>
                  </div>
                `,
                icon: 'success',
                confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
                confirmButtonColor: '#d31c25'
              });
            }
          })
          .catch(err => {
            Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏î‡πâ', 'error');
          });
      }
      
      Swal.close();
    }

    // Functions for truck stop popup buttons
    function preOrderAtStop(lat, lng, stopName) {
      Swal.fire({
        title: 'üì± ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤',
        html: `
          <p>‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà <strong>${stopName}</strong></p>
          <div style="text-align: left; margin: 15px 0;">
            <h4>üçΩÔ∏è ‡πÄ‡∏°‡∏ô‡∏π‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°:</h4>
            <label><input type="checkbox" value="‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î"> ‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î (40 ‡∏ö‡∏≤‡∏ó)</label><br>
            <label><input type="checkbox" value="‡∏™‡πâ‡∏°‡∏ï‡∏≥"> ‡∏™‡πâ‡∏°‡∏ï‡∏≥ (35 ‡∏ö‡∏≤‡∏ó)</label><br>
            <label><input type="checkbox" value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°"> ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏° (15 ‡∏ö‡∏≤‡∏ó)</label><br>
            <label><input type="checkbox" value="‡∏Ç‡∏ô‡∏°"> ‡∏Ç‡∏ô‡∏° (20 ‡∏ö‡∏≤‡∏ó)</label>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'üõí ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏•‡∏¢',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d'
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire({
            title: '‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
            text: '‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏à‡∏≠‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢',
            icon: 'success',
            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
            confirmButtonColor: '#28a745'
          });
        }
      });
    }
    
    function setReminder(lat, lng, stopName) {
      Swal.fire({
        title: 'üîî ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
        html: `
          <p>‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö <strong>${stopName}</strong></p>
          <div style="margin: 15px 0;">
            <label>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á:</label><br>
            <select id="reminderTime" style="width: 100%; padding: 8px; margin-top: 5px;">
              <option value="5">5 ‡∏ô‡∏≤‡∏ó‡∏µ</option>
              <option value="10" selected>10 ‡∏ô‡∏≤‡∏ó‡∏µ</option>
              <option value="15">15 ‡∏ô‡∏≤‡∏ó‡∏µ</option>
              <option value="30">30 ‡∏ô‡∏≤‡∏ó‡∏µ</option>
            </select>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: '‚è∞ ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#17a2b8',
        cancelButtonColor: '#6c757d'
      }).then((result) => {
        if (result.isConfirmed) {
          var reminderTime = document.getElementById('reminderTime').value;
          Swal.fire({
            title: '‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
            text: `‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏ñ‡∏ñ‡∏∂‡∏á ${reminderTime} ‡∏ô‡∏≤‡∏ó‡∏µ`,
            icon: 'success',
            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
            confirmButtonColor: '#17a2b8'
          });
        }
      });
    }
    
    function navigateToStop(lat, lng) {
      Swal.fire({
        title: 'üß≠ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á',
        text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏à‡∏∏‡∏î‡∏à‡∏≠‡∏î‡∏£‡∏ñ‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏î?',
        showDenyButton: true,
        showCancelButton: true,
        confirmButtonText: 'üì± Google Maps',
        denyButtonText: 'üçé Apple Maps',
        cancelButtonText: 'üó∫Ô∏è ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà',
        confirmButtonColor: '#4285f4',
        denyButtonColor: '#000000',
        cancelButtonColor: '#d31c25'
      }).then((result) => {
        if (result.isConfirmed) {
          openGoogleMaps(lat, lng);
        } else if (result.isDenied) {
          openAppleMaps(lat, lng);
        } else if (result.dismiss === Swal.DismissReason.cancel) {
          showDirectionsToStop(lat, lng);
        }
      });
    }
    
    function showDirectionsToStop(lat, lng) {
      // Show route to truck stop on map using OSRM
      var userLat = userMarker.getLatLng().lat;
      var userLng = userMarker.getLatLng().lng;
      
      var url = `https://router.project-osrm.org/route/v1/driving/${userLng},${userLat};${lng},${lat}?overview=full&geometries=geojson`;
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.routes && data.routes.length > 0) {
            var route = data.routes[0];
            var distance = (route.distance / 1000).toFixed(1);
            var duration = Math.round(route.duration / 60);
            
            // Add route to map
            var routeCoords = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
            L.polyline(routeCoords, {color: '#d31c25', weight: 4}).addTo(map);
            
            Swal.fire({
              title: 'üß≠ ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏à‡∏∏‡∏î‡∏à‡∏≠‡∏î‡∏£‡∏ñ',
              html: `
                <p><strong>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á:</strong> ${distance} ‡∏Å‡∏°.</p>
                <p><strong>‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì:</strong> ${duration} ‡∏ô‡∏≤‡∏ó‡∏µ</p>
                <p>‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡∏µ‡πÅ‡∏î‡∏á)</p>
              `,
              icon: 'info',
              confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
              confirmButtonColor: '#d31c25'
            });
          }
        })
        .catch(error => {
          console.error('Error fetching route:', error);
          Swal.fire({
            title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏î‡πâ',
            icon: 'error',
            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
          });
        });
    }

    // AI Route Functions
    function toggleAIRoute() {
      const panel = document.getElementById('aiPanel');
      panel.classList.add('active');
    }

    function closeAIRoute() {
      const panel = document.getElementById('aiPanel');
      panel.classList.remove('active');
    }

    function optimizeRoute() {
      Swal.fire({
        title: 'üéØ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á',
        html: `
          <div style="text-align: left; margin: 20px 0;">
            <p><strong>‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á:</strong></p>
            <p>‚Ä¢ ‡∏•‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏° 15%</p>
            <p>‚Ä¢ ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤ 20 ‡∏ô‡∏≤‡∏ó‡∏µ</p>
            <p>‚Ä¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ 3 ‡∏à‡∏∏‡∏î</p>
            <p>‚Ä¢ ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô 120 ‡∏ö‡∏≤‡∏ó/‡∏ß‡∏±‡∏ô</p>
          </div>
        `,
        icon: 'success',
        showCancelButton: true,
        confirmButtonText: '‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ô‡∏µ‡πâ',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#28a745'
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }
      });
    }

    function alternativeRoute() {
      Swal.fire({
        title: 'üîÑ ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å',
        html: `
          <div style="text-align: left;">
            <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px;">
              <strong>‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á A:</strong> ‡∏£‡∏ñ A ‚Üí ‡∏£‡∏ñ C ‚Üí ‡∏£‡∏ñ B<br>
              <small>‚è±Ô∏è 50 ‡∏ô‡∏≤‡∏ó‡∏µ | üìç 14 ‡∏Å‡∏°. | üí∞ ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î 20%</small>
            </div>
            <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px;">
              <strong>‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á B:</strong> ‡∏£‡∏ñ B ‚Üí ‡∏£‡∏ñ A ‚Üí ‡∏£‡∏ñ C<br>
              <small>‚è±Ô∏è 55 ‡∏ô‡∏≤‡∏ó‡∏µ | üìç 16 ‡∏Å‡∏°. | üí∞ ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î 15%</small>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á A',
        cancelButtonText: '‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°'
      });
    }

    function manageQueue() {
      Swal.fire({
        title: 'üìã ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢',
        html: `
          <div style="text-align: left;">
            <p><strong>‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong></p>
            <div style="margin: 10px 0;">
              <div style="background: #e8f5e8; padding: 8px; margin: 5px 0; border-radius: 5px;">
                üü¢ ‡∏£‡∏ñ A - ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢ (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏≠ 15 ‡∏Ñ‡∏ô)
              </div>
              <div style="background: #fff3cd; padding: 8px; margin: 5px 0; border-radius: 5px;">
                üü° ‡∏£‡∏ñ B - ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏° (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏≠ 8 ‡∏Ñ‡∏ô)
              </div>
              <div style="background: #f8d7da; padding: 8px; margin: 5px 0; border-radius: 5px;">
                üî¥ ‡∏£‡∏ñ C - ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏≠ 3 ‡∏Ñ‡∏ô)
              </div>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏¥‡∏ß',
        cancelButtonText: '‡∏õ‡∏¥‡∏î'
      });
    }

    function weatherRoute() {
      Swal.fire({
        title: 'üå§Ô∏è ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®',
        html: `
          <div style="text-align: left;">
            <p><strong>‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</strong> ‚òÄÔ∏è ‡πÅ‡∏î‡∏î‡∏à‡∏±‡∏î 35¬∞C</p>
            <p><strong>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong></p>
            <p>‚Ä¢ ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏•‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á 11:00-15:00</p>
            <p>‚Ä¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡πà‡∏°‡πÅ‡∏•‡∏∞‡πÉ‡∏Å‡∏•‡πâ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</p>
            <p>‚Ä¢ ‡πÄ‡∏ô‡πâ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°‡πÄ‡∏¢‡πá‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏®‡∏Å‡∏£‡∏µ‡∏°</p>
            <p>‚Ä¢ ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡πà‡∏°‡πÄ‡∏á‡∏≤</p>
          </div>
        `,
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: '‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á',
        cancelButtonText: '‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏±‡∏ö'
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire('‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß!', '‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }
      });
    }

    // ...existing code...
  </script>
  
</body>
</html>